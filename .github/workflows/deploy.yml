name: Auto Deploy to Linux Server

on:
  push:
    branches: [ main ] # ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£ push ‡πÑ‡∏õ‡∏ó‡∏µ‡πà branch main

jobs:
  deploy:
    runs-on: self-hosted  # ‡πÉ‡∏ä‡πâ self-hosted runner
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy
        run: |
          echo "üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏° Deploy..."
          cd /var/www/fullstack-app
          
          # Pull ‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
          echo "üì• Pull ‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î..."
          git pull origin main || echo "‚ö†Ô∏è  Pull failed, ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ remote"
          
          # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ directory ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          if [ ! -d "backend" ] && [ ! -d "frontend" ]; then
            echo "‚ö†Ô∏è  ‡πÑ‡∏°‡πà‡∏û‡∏ö backend/frontend directories"
            echo "üí° ‡∏™‡∏£‡πâ‡∏≤‡∏á directory structure..."
            mkdir -p backend frontend
          fi
          
          # ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Backend (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          if [ -d "backend" ] && [ -f "backend/package.json" ]; then
            echo "üîß ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Backend..."
            cd backend
            npm install
            if [ -f "prisma/schema.prisma" ]; then
              npx prisma generate
              npx prisma migrate deploy
            fi
            pm2 restart api-service || echo "‚ö†Ô∏è  PM2 service ‡πÑ‡∏°‡πà‡∏û‡∏ö"
            cd ..
          else
            echo "‚ÑπÔ∏è  ‡πÑ‡∏°‡πà‡∏û‡∏ö backend ‡∏´‡∏£‡∏∑‡∏≠ package.json"
          fi
          
          # ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Frontend (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          if [ -d "frontend" ] && [ -f "frontend/package.json" ]; then
            echo "üîß ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Frontend..."
            cd frontend
            npm install
            npm run build || echo "‚ö†Ô∏è  Build failed"
            cd ..
          else
            echo "‚ÑπÔ∏è  ‡πÑ‡∏°‡πà‡∏û‡∏ö frontend ‡∏´‡∏£‡∏∑‡∏≠ package.json"
          fi
          
          echo "‚úÖ Deploy ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!"
